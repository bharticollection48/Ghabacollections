<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghaba - UPI Payment</title>
    
    <link rel="icon" type="image/png" href="https://img.freepik.com/premium-vector/shopping-logo-vector-icon_636116-200.jpg?semt=ais_hybrid&w=740&q=80"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #ffffff; text-align: center; color: #333; }
        .qr-header { background: #9c27b0; color: white; padding: 20px 10px; border-radius: 0 0 25px 25px; }
        .qr-header h1 { margin: 0; font-size: 22px; }
        .timer-box { margin: 20px 0; font-size: 18px; color: #ff4757; font-weight: bold; }
        #countdown { font-size: 24px; display: block; margin-top: 5px; }
        .amount-tag { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .amount-tag small { font-size: 14px; color: #666; font-weight: normal; }
        .qr-main-box {
            margin: 10px auto;
            padding: 15px;
            width: 260px;
            min-height: 260px;
            border: 2px solid #9c27b0;
            border-radius: 20px;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #qrImage { width: 100%; height: auto; display: none; } /* Shuru mein hidden jab tak link na bane */
        .note { font-size: 13px; color: #666; padding: 0 30px; line-height: 1.5; margin-top: 20px; }
        
        /* Loading Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #9c27b0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #statusText { font-size: 14px; color: #9c27b0; font-weight: bold; }
    </style>
</head>
<body>

    <div class="qr-header">
        <h1><i class="fa-solid fa-qrcode"></i> UPI Payment</h1>
    </div>

    <div class="timer-box">
        Kripya payment poori karein...
        <span id="countdown">05:00</span>
    </div>

    <div class="amount-tag">
        <small>Payable Amount:</small><br>
        <span id="displayAmount">₹0</span>
    </div>

    <div class="qr-main-box" id="qrContainer">
        <div class="loader" id="mainLoader"></div>
        <img id="qrImage" src="" alt="QR Loading...">
    </div>

    <div id="statusText">Fetching secure payment link...</div>

    <div class="note">
        System aapki payment ka intezar kar raha hai. <b>QR scan karke payment karein</b>, page ko refresh na karein.
    </div>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbw8hdjGjnymgMQTE4c0gMmI0VVCWoEubyLyeOuo2pfbegv1ISFU2O6acvWM75hThJX8/exec";

        window.onload = async function () {
            // 1. LocalStorage se Amount uthao
            let price = localStorage.getItem("checkoutPrice");

            if (!price || price == 0) {
                alert("Payment amount not found!");
                window.location.href = "index.html";
                return;
            }
            document.getElementById("displayAmount").innerText = "₹" + price;

            try {
                // 2. SERVER SE UPI ID LAO (Sabse naya wala)
                // Cache bypass karne ke liye timestamp lagaya hai
                const response = await fetch(GOOGLE_SHEET_URL + "?t=" + Date.now());
                const data = await response.json();
                const LATEST_UPI = data.settings.upi;

                // 3. QR GENERATE KARO
                let upiLink = `upi://pay?pa=${LATEST_UPI}&pn=GhabaOrder&am=${price}&cu=INR`;
                let qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiLink)}`;
                
                const img = document.getElementById("qrImage");
                img.src = qrUrl;
                
                // Jab image load ho jaye tab loader hatao
                img.onload = function() {
                    document.getElementById("mainLoader").style.display = "none";
                    img.style.display = "block";
                    document.getElementById("statusText").innerText = "QR Code Ready ✅";
                    document.getElementById("statusText").style.color = "green";
                };

            } catch (error) {
                console.error("QR Load Error:", error);
                document.getElementById("statusText").innerText = "Server Error! Kripya dobara koshish karein.";
                document.getElementById("statusText").style.color = "red";
            }

            // 4. Timer chalao
            startTimer(300);
        };

        function startTimer(duration) {
            let timer = duration;
            let display = document.getElementById("countdown");

            let interval = setInterval(function () {
                let minutes = Math.floor(timer / 60);
                let seconds = timer % 60;

                display.textContent = (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    alert("Time khatam ho gaya! Order session expired.");
                    window.location.href = "index.html";
                }
            }, 1000);
        }
    </script>

</body>
</html>